<head>
  <style>
    body {
      margin: 0;
    }

    #controls {
      background: rgba(255, 255, 255, .8);
      display: flex;
      justify-content: space-around;
      padding: 8px;
      position: absolute;
      width: 100vw;
      z-index: 2;
    }
  </style>

  <script crossorigin="anonymous" src="https://unpkg.com/three"></script>
  <script crossorigin="anonymous" src="https://unpkg.com/3d-force-graph"></script>
</head>

<body>
  <div id="controls">
    <label title="peak signal-to-noise ratio">
      PSNR
      <input type="checkbox" id="psnr-onoff" checked>
      <input type="range" id="psnr" min="0" max="1" step="0.1" value="0.5">
    </label>
    <label title="root mean squared error">
      RMSE
      <input type="checkbox" id="rmse-onoff" checked>
      <input type="range" id="rmse" min="0" max="1" step="0.1" value="0.5">
    </label>
    <label title="spectral angle mapper">
      SAM
      <input type="checkbox" id="sam-onoff" checked>
      <input type="range" id="sam" min="0" max="1" step="0.1" value="0.5">
    </label>
    <label title="ame string similarity">
      Name
      <input type="checkbox" id="name-onoff" checked>
      <input type="range" id="name" min="0" max="1" step="0.1" value="0.5">
    </label>

  </div>

  <div id="3d-graph"></div>

  <script>

    const graph = ForceGraph3D()(document.getElementById("3d-graph"))
      .nodeThreeObject(({ path }) => {
        const imgTexture = new THREE.TextureLoader().load(path);
        const material = new THREE.SpriteMaterial({ map: imgTexture });
        const sprite = new THREE.Sprite(material);
        sprite.scale.set(12, 12);
        return sprite;
      })
      .jsonUrl('graph.json')
      .onNodeDragEnd((node) => {
        node.fx = node.x;
        node.fy = node.y;
        node.fz = node.z;
      });

    const update = () => {
      document.querySelectorAll("input[type='checkbox']").forEach(
        elem => elem.nextElementSibling.disabled = !elem.checked);
      graph.numDimensions(3); // Re-heat simulation
    }

    document.querySelectorAll("input").forEach(elem => elem.addEventListener("input", update));

    const linkForce = graph
      .d3Force('link')
      .distance(link => {
        const dist =
          ((1 - link["img-sim"].psnr) * document.getElementById("psnr").value * document.getElementById("psnr-onoff").checked) +
          ((1 - link["img-sim"].rmse) * document.getElementById("rmse").value * document.getElementById("rmse-onoff").checked) +
          ((1 - link["img-sim"].sam) * document.getElementById("sam").value * document.getElementById("sam-onoff").checked) +
          ((1 - link["name-sim"]) * document.getElementById("name").value * document.getElementById("name-onoff").checked);
        console.log(`${link.source.name} <-> ${link.target.name}: ${dist}`);
        return dist * 100;
      })
      .strength(1);
  </script>
</body>
